# 2.8 使用CCR等中转工具

## 2.8.1 概述
Claude Code默认需要直接连接到Anthropic的API服务器，但在某些情况下（如网络限制、访问速度慢等），用户可能需要使用中转工具来代理Claude Code的请求。CCR（ClaudeCodeRouter）是一种常用的中转工具，它可以将Claude Code的请求进行代理中转，帮助用户解决网络连接问题，提高访问速度，甚至实现一些高级功能。本节将介绍如何使用CCR等中转工具来优化Claude Code的使用体验。

```
## 2.8.2 什么是ClaudeCodeRouter (CCR)

### 2.8.2.1 基本概念

```
ClaudeCodeRouter（简称CCR）是一个开源的Claude Code请求转发工具，它可以：

  * 代理Claude Code的API请求
  * 优化网络连接，提高访问速度
  * 支持多种大模型的统一接入
  * 提供请求日志和监控功能
  * 支持自定义路由规则和流量控制

### 2.8.2.2 核心功能
  1. **请求代理** ：将Claude Code的API请求转发到目标服务器
  2. **多模型支持** ：支持同时接入多个大模型API
  3. **负载均衡** ：在多个API端点之间分配请求负载
  4. **缓存机制** ：缓存常用请求的响应，提高性能
  5. **安全控制** ：提供API密钥管理和访问控制

```
## 2.8.3 安装ClaudeCodeRouter

### 2.8.3.1 系统要求

```
  * Node.js 18.0.0 或更高版本
  * npm 或 pnpm 包管理器
  * 足够的系统内存和存储空间

### 2.8.3.2 安装步骤
  1. **安装Node.js** ：

```
     * 访问Node.js官方网站（[https://nodejs.org/）下载并安装最新版本的Node.js](https://nodejs.org/%EF%BC%89%E4%B8%8B%E8%BD%BD%E5%B9%B6%E5%AE%89%E8%A3%85%E6%9C%80%E6%96%B0%E7%89%88%E6%9C%AC%E7%9A%84Node.js)
     * 安装完成后，打开终端验证安装：

           bash


           node --version
           npm --version

```
  2. **安装ClaudeCodeRouter** ：

```
         bash


         npm install -g @musistudio/claude-code-router

```
或使用pnpm：

```
         bash


         pnpm add -g @musistudio/claude-code-router

```
  3. **验证安装** ：

```
         bash


         ccr --version

## 2.8.4 配置ClaudeCodeRouter

### 2.8.4.1 创建配置文件

```
  1. **创建配置目录** ：

```
         bash


         mkdir -p ~/.claude-code-router

```
  2. **创建配置文件** ：

```
         bash


         touch ~/.claude-code-router/config.json

```
  3. **编辑配置文件** ：

```
         json


         {
           "port": 3000,
           "logLevel": "info",
           "endpoints": [
             {
               "name": "anthropic",
               "type": "anthropic",
               "apiKey": "your-anthropic-api-key",
               "baseUrl": "https://api.anthropic.com/v1"
             },
             {
               "name": "glm",
               "type": "custom",
               "apiKey": "your-glm-api-key",
               "baseUrl": "https://api.glm.example.com/v1",
               "headers": {
                 "Content-Type": "application/json"
               }
             }
           ],
           "defaultEndpoint": "anthropic",
           "cache": {
             "enabled": true,
             "ttl": 3600
           }
         }

### 2.8.4.2 配置参数说明

```
  * **port** ：CCR服务器监听的端口
  * **logLevel** ：日志级别（debug、info、warn、error）
  * **endpoints** ：配置的API端点列表
```
    * **name** ：端点名称
    * **type** ：端点类型（anthropic、custom等）
    * **apiKey** ：API密钥
    * **baseUrl** ：API基础URL
    * **headers** ：自定义请求头
```
  * **defaultEndpoint** ：默认使用的端点
  * **cache** ：缓存配置
```
    * **enabled** ：是否启用缓存
    * **ttl** ：缓存过期时间（秒）

## 2.8.5 启动ClaudeCodeRouter

### 2.8.5.1 基本启动命令

    bash


    ccr start

### 2.8.5.2 自定义启动参数

    bash


    # 指定配置文件
    ccr start --config ~/my-ccr-config.json

    # 指定端口
    ccr start --port 4000

    # 启用调试模式
    ccr start --debug

### 2.8.5.3 后台运行

```
在Linux/macOS系统上，可以使用nohup或systemd来后台运行CCR：

```
    bash


    nohup ccr start > ~/.claude-code-router/ccr.log 2>&1 &

## 2.8.6 配置Claude Code使用中转服务

### 2.8.6.1 在VS Code中配置

```
  1. 打开VS Code
  2. 点击左侧边栏的**Claude Code** 图标
  3. 点击右上角的**设置** 按钮（齿轮图标）
  4. 选择**高级设置**
  5. 在**API端点** 字段中输入：

```
         bash


         http://localhost:3000/v1

```
  6. 在**API密钥** 字段中输入：

```
         bash


         ccr:your-anthropic-api-key

```
  7. 点击**保存** 按钮

### 2.8.6.2 在命令行中配置
  1. 打开终端或命令提示符
  2. 运行以下命令配置API端点：

```
         bash


         claude config set api-endpoint http://localhost:3000/v1

```
  3. 配置API密钥：

```
         bash


         claude config set api-key "ccr:your-anthropic-api-key"

## 2.8.7 其他常用中转工具

### 2.8.7.1 AnyRouter

```
  * **特点** ：功能强大的API路由和转发工具
  * **优势** ：支持多种API协议，提供丰富的路由规则
  * **使用方式** ：下载并部署AnyRouter，配置路由规则

### 2.8.7.2 Cloudflare Workers
  * **特点** ：基于Cloudflare边缘网络的无服务器函数
  * **优势** ：全球边缘节点，低延迟访问
  * **使用方式** ：编写并部署Cloudflare Worker脚本

## 2.8.8 注意事项
  1. **网络安全** ：使用中转工具时，注意保护API密钥和敏感数据
  2. **性能影响** ：中转工具可能会对请求响应时间产生一定影响
  3. **可靠性** ：自行部署的中转服务需要考虑高可用性和故障恢复
  4. **合规性** ：确保使用中转工具符合相关法律法规和服务条款
  5. **成本控制** ：使用第三方中转服务时，注意了解相关费用和使用限制
  6. **更新维护** ：定期更新中转工具和配置，确保安全性和稳定性