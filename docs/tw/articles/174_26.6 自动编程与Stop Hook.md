# 26.6 自動程式設計與Stop Hook

## 自動程式設計概述
在2026年，Claude Code的自動程式設計功能已經成為構建自主、自我修復開發工作流的標準。透過Stop hook（停止鉤子）等高階功能，開發者可以實現"Auto Code Forever"（永遠自動編碼）的工作模式，讓Claude Code能夠在無人干預的情況下持續執行數小時甚至數天，自主完成從程式碼生成到測試修復的全流程。

```
## Stop Hook核心概念

### 1\. 什么是Stop Hook

```
Stop Hook是Claude Code在每個工作週期結束時自動執行的操作，可以是shell命令或基於LLM的提示。與普通提示不同，Hook是由環境強制執行的保證動作，提供了確定性的控制機制。

#### Stop Hook的型別
  * **命令型別Hook** ：執行shell命令，用於檢查錯誤、執行測試或執行其他自動化任務
  * **提示型別Hook** ：使用"type: prompt"配置，允許LLM評估工作是否真正完成或是否需要觸發後續操作

```
### 2\. Stop Hook的工作原理

    bash


    ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
    │ Claude完成任务  │────▶│ Stop Hook触发   │────▶│ 执行检查/评估   │
    └─────────────────┘     └─────────────────┘     └─────────────────┘
                                   ▲                      │
                                   │                      ▼
    ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
    │ 继续执行任务    │◀────│ 反馈结果给Claude │◀────│ 生成反馈/指令   │
    └─────────────────┘     └─────────────────┘     └─────────────────┘

## 实现"Auto Code Forever"的模式

### 1\. 链式反应循环

```
配置Stop Hook執行指令碼檢查錯誤（ linting、測試等）。如果發現錯誤，指令碼會以特定狀態退出，迫使Claude重新評估並繼續修復程式碼。

```bash
    bash


    # 示例：使用Biome进行代码检查的Stop Hook脚本
    #!/bin/bash

    # 运行代码检查
    npx biome check src

    # 如果发现错误，以状态码1退出，提示Claude继续修复
    if [ $? -ne 0 ]; then
        echo "发现代码错误，请Claude继续修复"
        exit 1
    fi

    echo "代码检查通过，任务完成"
    exit 0

### 2\. 自主Agent框架

```
使用者在遠端VPS伺服器（如AWS EC2或Hetzner）上部署Claude Code，並使用`--dangerously-skip-permissions`標誌繞過手動批准提示，使其能夠24/7無人工干預執行。

```
    bash


    # 示例：在远程服务器上启动Claude Code的命令
    claude --dangerously-skip-permissions --project-path /home/user/my-project

### 3\. Todo驱动开发

```
透過維護PROJECT.md或todo.md檔案，使用Hook在當前任務結束後立即向Claude提供列表中的下一個任務。

```bash
    markdown


    # todo.md示例

    ## 待办任务
    1. ✅ 实现用户认证功能
    2. ⏳ 开发数据模型
    3. ⏳ 集成API接口
    4. ⏳ 编写测试用例

    bash


    # 示例：读取下一个任务的Hook脚本
    #!/bin/bash

    # 查找下一个未完成的任务
    next_task=$(grep -n "⏳" todo.md | head -1)

    # 如果找到任务，以状态码1退出并提供下一个任务
    if [ ! -z "$next_task" ]; then
        echo "当前任务完成，下一个任务：$next_task"
        exit 1
    fi

    echo "所有任务已完成"
    exit 0

## 设置与命令

### 1\. 配置Hook

```
在終端中輸入`/hooks`開啟互動式配置選單，或直接編輯配置檔案：

```
    json


    // claude/settings.json
    {
      "hooks": {
        "Stop": {
          "type": "command",
          "command": "./scripts/check-code.sh",
          "match": ".*"
        },
        "PostToolUse": {
          "type": "command",
          "command": "./scripts/format-code.sh",
          "match": ".*\.(js|ts|tsx)$"
        }
      }
    }

### 2\. 自动继续命令

```
使用以下命令允許Agent在不請求許可權的情況下執行shell命令和檔案編輯：

```
    bash


    claude --dangerously-skip-permissions

### 3\. 中断操作

```
  * 按Escape鍵停止當前工作週期
  * 按Ctrl+C完全退出會話

```
## 流行的自动化工具

### 1\. claude-mem

```
一個外掛，用於在無限會話中保留專案上下文，防止AI在長時間執行的任務中"變笨"或失去目標跟蹤。

### 2\. CC AutoRenew
防止會話過期間隙的工具，確保Agent在計劃的編碼塊期間保持活躍。

```
## 注意事项与最佳实践

### 1\. 避免无限循环

```
  * 謹慎使用呼叫claude的Hook
  * 使用條件或最大迭代次數防止失控成本
  * 示例：在指令碼中新增計數器

```bash
    bash


    #!/bin/bash

    # 检查是否达到最大迭代次数
    if [ -f .iteration_count ]; then
        count=$(cat .iteration_count)
        if [ $count -ge 10 ]; then
            echo "已达到最大迭代次数10，停止自动修复"
            exit 0
        fi
        count=$((count+1))
    else
        count=1
    fi

    echo $count > .iteration_count

    # 继续执行检查...

### 2\. 错误处理

```
  * 使用非零退出碼向Claude發出問題訊號
  * 狀態碼2會阻止繼續執行

### 3\. 安全考慮
  * `--dangerously-skip-permissions`標誌會繞過所有許可權檢查，請謹慎使用
  * 在生產環境中建議保留手動批准機制
  * 定期監控長時間執行的任務

```
## 自动编程的应用场景

### 1\. 自主代码修复

```
設定Stop Hook自動執行測試和lint檢查，當發現錯誤時自動讓Claude修復，直到所有測試透過。

### 2\. 持續整合工作流
將Claude Code整合到CI/CD管道中，實現從程式碼提交到部署的全自動化流程。

### 3\. 夜間批次處理
在非工作時間執行Claude Code處理大量重複任務，如程式碼重構、文件生成等。

## 總結
Claude Code的自動程式設計功能，特別是Stop Hook機制，為開發者提供了前所未有的自動化能力。透過合理配置和使用這些工具，開發者可以實現"Auto Code Forever"的工作模式，大幅提高開發效率和程式碼質量。

自動程式設計與Interview Mode、Plan Mode、子Agent等功能相結合，構成了Claude Code強大的Agentic程式設計能力體系，使開發者能夠處理更加複雜和多樣化的任務，同時確保結果符合預期。