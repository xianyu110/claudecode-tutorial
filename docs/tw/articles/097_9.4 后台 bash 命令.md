# 9.4 後臺 bash 命令

Claude Code 提供了強大的後臺命令執行功能，允許您在執行長時間執行的程序時繼續與 Claude 互動。這極大地提高了工作效率，特別是在處理構建、測試或開發伺服器等耗時任務時。

## 工作原理

當您在後臺執行命令時，Claude Code 會非同步執行該命令，並立即返回一個唯一的後臺任務 ID。這意味著您可以在命令繼續執行的同時，繼續向 Claude 提問或執行其他任務。

### 核心特性


  * **非同步執行** ：命令在後臺執行，不阻塞您的工作流
  * **輸出緩衝** ：命令輸出會被緩衝，您可以隨時檢索
  * **任務跟蹤** ：每個後臺任務都有唯一的 ID，方便管理
  * **自動清理** ：當 Claude Code 退出時，所有後臺任務會被自動清理
  * **實時監控** ：可以隨時檢查任務狀態和輸出

## 启动后台命令

### 1\. 通过提示启动


最簡單的方式是直接在提示中要求 Claude 在後臺執行命令：

```
    bash


    在后台运行 npm install
    [后台任务 ID: task-12345 已启动]

### 2\. 使用 Ctrl+B 快捷键

```

您可以使用 `Ctrl+B` 組合鍵將正在執行的常規 Bash 命令移到後臺：

```
    bash


    npm test
    [按 Ctrl+B]
    [任务已移至后台，ID: task-12346]

```

**注意** : Tmux 使用者需要按 `Ctrl+B` 兩次，因為 Tmux 預設使用 `Ctrl+B` 作為字首鍵。

### 3\. 使用 /background 命令

您也可以使用 `/background` 命令顯式地將命令移到後臺：

```bash
    bash


    /background npm run dev
    [后台任务 ID: task-12347 已启动]

## 常见的后台命令场景

### 1\. 构建工具

    bash


    在后台运行 webpack build
    [后台任务 ID: task-12348 已启动]

### 2\. 包管理器

    bash


    在后台运行 npm install
    [后台任务 ID: task-12349 已启动]

### 3\. 测试运行器

    bash


    在后台运行 jest --watch
    [后台任务 ID: task-12350 已启动]

### 4\. 开发服务器

    bash


    在后台运行 npm run dev
    [后台任务 ID: task-12351 已启动]

### 5\. 长时间运行的进程

    bash


    在后台运行 docker-compose up
    [后台任务 ID: task-12352 已启动]

### 6\. 文件监控

    bash


    在后台运行 nodemon server.js
    [后台任务 ID: task-12353 已启动]

## 管理后台任务

### 1\. 查看所有后台任务

```

您可以隨時檢視當前正在執行的後臺任務列表：

```
    bash


    列出所有后台任务
    正在运行的后台任务：
    - task-12345: npm install (运行中)
    - task-12346: npm test (运行中)
    - task-12347: npm run dev (运行中)

### 2\. 检查任务状态

```

您可以檢查特定任務的詳細狀態：

```
    bash


    检查任务 task-12345 的状态
    任务 task-12345 状态：
    - 命令: npm install
    - 状态: 运行中
    - 运行时间: 2分30秒
    - PID: 12345

### 3\. 获取任务输出

```

當命令完成或需要檢視中間輸出時，您可以獲取任務的輸出：

```
    bash


    获取任务 task-12345 的输出
    added 1423 packages in 2m
    found 0 vulnerabilities

### 4\. 停止后台任务

```

如果需要，可以停止正在執行的後臺任務：

```
    bash


    停止任务 task-12345
    任务 task-12345 已停止

### 5\. 清理已完成的任务

```

您可以清理已完成的後臺任務，保持任務列表整潔：

```
    bash


    清理已完成的任务
    已清理 2 个已完成的后台任务

## 使用场景

### 1\. 并行工作

```

後臺命令最強大的用途之一是允許您在執行耗時任務的同時繼續工作。例如：

```javascript
    bash


    # 启动后台构建
    在后台运行 npm run build

    # 同时询问 Claude 问题
    请解释这段 React 代码的工作原理：
    function App() {
      const [count, setCount] = useState(0);
      return <button onClick={() => setCount(count + 1)}>{count}</button>;
    }

### 2\. 监控长时间运行的进程

```

對於需要持續執行的程序（如開發伺服器），後臺執行非常有用：

```
    bash


    # 启动后台开发服务器
    在后台运行 npm run dev

    # 查看服务器输出
    获取任务 task-12347 的输出
    Compiled successfully!
    You can now view my-app in the browser.
    Local:            http://localhost:3000

### 3\. 批量处理

```

您可以同時啟動多個後臺任務，提高工作效率：

```
    bash


    # 同时启动多个任务
    在后台运行 npm install
    在后台运行 npm run lint
    在后台运行 npm test

    # 查看所有任务状态
    列出所有后台任务

## 最佳实践

```

  1. **合理命名任務** ：在啟動後臺任務時，儘量使用清晰的描述，便於後續管理
  2. **定期檢查狀態** ：對於長時間執行的任務，定期檢查狀態以確保它們正常執行
  3. **及時清理** ：任務完成後，及時清理已完成的任務，保持任務列表整潔
  4. **注意資源使用** ：避免同時執行過多的後臺任務，以免消耗過多系統資源
  5. **監控輸出** ：對於重要任務，定期檢查輸出以確保它們按預期執行

## 故障排除

### 后台任务不启动


  * 檢查命令格式是否正確
  * 確保您有足夠的許可權執行該命令
  * 嘗試使用 `/background` 命令顯式啟動

### 無法獲取任務輸出


  * 確保任務 ID 正確
  * 檢查任務是否已經完成
  * 嘗試等待片刻再獲取輸出

### 後臺任務意外停止


  * 檢查命令是否有錯誤輸出
  * 檢視系統日誌以獲取更多資訊
  * 嘗試在前臺執行命令以除錯問題

### Ctrl+B 快捷鍵不工作


  * 確保沒有其他程式佔用 `Ctrl+B` 快捷鍵
  * 對於 Tmux 使用者，嘗試按兩次 `Ctrl+B`
  * 檢查終端的快捷鍵設定

## 高级技巧

### 1\. 任务依赖


您可以建立任務之間的依賴關係，確保任務按順序執行：

```
    bash


    在后台运行 npm install && npm run build
    [后台任务 ID: task-12354 已启动]

### 2\. 输出重定向

```

您可以將任務輸出重定向到檔案：

```
    bash


    在后台运行 npm run build > build.log 2>&1
    [后台任务 ID: task-12355 已启动]

### 3\. 定时任务

```

您可以結合 `cron` 或其他定時工具建立定時後臺任務：

```bash
    bash


    在后台运行 "* * * * * /usr/bin/node /path/to/script.js"
    [后台任务 ID: task-12356 已启动]

### 并行开发

    bash


    bash

    # 启动开发服务器
    在后台运行 npm run dev
    [后台任务 ID: task-12352 已启动]

    # 同时运行测试
    在后台运行 npm test
    [后台任务 ID: task-12353 已启动]

    # 继续开发
    创建一个新的组件

    ### 长时间构建

    # 启动构建
    在后台运行 webpack --mode production
    [后台任务 ID: task-12354 已启动]
    # 在构建时继续工作
    编写测试用例

### 监控服务

    bash


    bash

    # 启动监控
    在后台运行 npm run watch
    [后台任务 ID: task-12355 已启动]

    # 查看输出
    获取任务 task-12355 的输出

    ## Bash 模式

    使用 `!` 前缀直接运行 bash 命令：

    ! npm test
    ! git status
    ! ls -la

### Bash 模式特性


  * 將命令及其輸出新增到對話上下文
  * 顯示實時進度和輸出
  * 支援相同的 `Ctrl+B` 後臺執行
  * 不需要 Claude 解釋或批准命令

### Bash 模式示例

    bash


    bash

    # 快速检查状态
    ! git status

    # 运行测试
    ! npm test

    # 查看文件
    ! cat package.json

    ```

```
    ## 最佳实践

    1. **合理使用**: 对于长时间运行的命令使用后台模式
    2. **监控输出**: 定期检查后台任务的输出
    3. **清理任务**: 及时停止不再需要的后台任务
    4. **任务命名**: 为后台任务添加描述性名称便于识别

    ## 注意事项

    - 后台任务在 Claude Code 退出时会自动清理
    - 后台任务的输出是缓冲的，可能不会实时显示
    - 太多后台任务可能影响性能
    - 某些命令可能不适合在后台运行

    ## 故障排除

    ### 后台任务失败

    1. 检查任务输出了解错误原因
    2. 确认命令语法正确
    3. 检查依赖项是否已安装

    ### 无法停止任务

    1. 尝试使用 `pkill` 命令
    2. 重启 Claude Code
    3. 手动终止进程

    ### 输出不显示

    1. 等待缓冲区填充
    2. 手动获取任务输出
    3. 检查任务是否仍在运行

```

```
