# 8.3 CI/CD 整合

持續整合（CI）和持續部署（CD）是現代軟體開發流程的核心組成部分。將 Claude Code 整合到 CI/CD 流程中，可以自動化程式碼審查、測試、文件生成等任務，顯著提高開發效率和程式碼質量。

## CI/CD 集成概述

### 为什么集成 Claude Code 到 CI/CD


將 Claude Code 整合到 CI/CD 流程中可以帶來以下好處：

  * **自動化程式碼審查** ：在每次提交時自動進行程式碼審查
  * **智慧測試生成** ：自動生成測試用例和測試程式碼
  * **文件自動生成** ：自動生成和更新專案文件
  * **程式碼質量檢查** ：自動檢查程式碼質量、安全性和效能問題
  * **減少人工干預** ：減少重複性的人工任務
  * **提高開發效率** ：加快開發和部署流程

### CI/CD 整合的挑戰

在整合 Claude Code 到 CI/CD 時，需要考慮以下挑戰：

  * **認證配置** ：需要配置 Anthropic API 認證
  * **環境變數管理** ：安全地管理敏感資訊
  * **錯誤處理** ：處理 Claude Code 執行失敗的情況
  * **效能最佳化** ：最佳化 CI/CD 流程的執行時間
  * **成本控制** ：控制 API 呼叫成本
  * **結果展示** ：將 Claude Code 的結果展示在 CI/CD 介面中

```bash
## GitHub Actions 集成

### 1\. 基本配置

#### 示例：GitHub Actions 工作流

    yaml


    name: Claude Code CI

    on:
      push:
        branches: [ main, develop ]
      pull_request:
        branches: [ main ]

    jobs:
      code-review:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Setup Node.js
            uses: actions/setup-node@v3
            with:
              node-version: '18'

          - name: Install Claude Code
            run: npm install -g @anthropic-ai/claude-code

          - name: Configure Claude Code
            env:
              ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
            run: |
              claude login --api-key $ANTHROPIC_API_KEY

          - name: Run code review
            run: |
              claude -p "审查最近的代码变更" \
                --output-format json \
                > review.json

          - name: Upload review results
            uses: actions/upload-artifact@v3
            with:
              name: code-review
              path: review.json

### 2\. 代码审查工作流

#### 示例：自动代码审查

    yaml


    name: Automated Code Review

    on:
      pull_request:
        types: [opened, synchronize, reopened]

    jobs:
      code-review:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3
            with:
              fetch-depth: 0

          - name: Install Claude Code
            run: npm install -g @anthropic-ai/claude-code

          - name: Configure Claude Code
            env:
              ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
            run: |
              claude login --api-key $ANTHROPIC_API_KEY

          - name: Get changed files
            id: changed-files
            run: |
              git diff --name-only origin/main...HEAD > changed_files.txt
              echo "files=$(cat changed_files.txt)" >> $GITHUB_OUTPUT

          - name: Review changed files
            run: |
              claude -p "审查以下文件的代码质量、安全性和性能：" \
                --input-format text \
                --output-format json \
                < changed_files.txt \
                > review.json

          - name: Post review as comment
            uses: actions/github-script@v6
            with:
              script: |
                const fs = require('fs');
                const review = JSON.parse(fs.readFileSync('review.json', 'utf8'));

                let comment = '## 代码审查结果\n\n';
                comment += `**审查时间**: ${new Date().toISOString()}\n\n`;
                comment += '### 审查意见\n\n';
                comment += review.content || '无审查意见';

                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });

### 3\. 测试生成和执行

#### 示例：自动测试生成

    yaml


    name: Automated Testing

    on:
      push:
        branches: [ main, develop ]
      pull_request:
        branches: [ main ]

    jobs:
      generate-tests:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Install Claude Code
            run: npm install -g @anthropic-ai/claude-code

          - name: Configure Claude Code
            env:
              ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
            run: |
              claude login --api-key $ANTHROPIC_API_KEY

          - name: Generate unit tests
            run: |
              claude -p "为所有 Python 文件生成单元测试" \
                --output-format json \
                > unit_tests.json

          - name: Generate integration tests
            run: |
              claude -p "为 API 端点生成集成测试" \
                --output-format json \
                > integration_tests.json

          - name: Save generated tests
            uses: actions/upload-artifact@v3
            with:
              name: generated-tests
              path: |
                unit_tests.json
                integration_tests.json

      run-tests:
        needs: generate-tests
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Download generated tests
            uses: actions/download-artifact@v3
            with:
              name: generated-tests

          - name: Setup Python
            uses: actions/setup-python@v4
            with:
              python-version: '3.10'

          - name: Install dependencies
            run: |
              pip install pytest pytest-cov

          - name: Run unit tests
            run: |
              claude -p "运行单元测试" \
                --input-format json \
                < unit_tests.json

          - name: Run integration tests
            run: |
              claude -p "运行集成测试" \
                --input-format json \
                < integration_tests.json

          - name: Generate coverage report
            run: |
              claude -p "生成测试覆盖率报告" \
                --output-format json \
                > coverage.json

          - name: Upload coverage report
            uses: actions/upload-artifact@v3
            with:
              name: coverage-report
              path: coverage.json

### 4\. 文档生成工作流

#### 示例：自动文档生成

    yaml


    name: Documentation Generation

    on:
      push:
        branches: [ main ]
      pull_request:
        branches: [ main ]

    jobs:
      generate-docs:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Install Claude Code
            run: npm install -g @anthropic-ai/claude-code

          - name: Configure Claude Code
            env:
              ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
            run: |
              claude login --api-key $ANTHROPIC_API_KEY

          - name: Extract API documentation
            run: |
              claude -p "提取所有 API 端点的文档" \
                --output-format json \
                > api_docs.json

          - name: Generate Markdown documentation
            run: |
              claude -p "根据提取的信息生成 Markdown 文档" \
                --input-format json \
                --output-format markdown \
                > API.md

          - name: Generate HTML documentation
            run: |
              claude -p "根据提取的信息生成 HTML 文档" \
                --input-format json \
                --output-format html \
                > API.html

          - name: Commit documentation
            run: |
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              git add API.md API.html
              git diff --quiet && git diff --staged --quiet || git commit -m "Update documentation"
              git push

## GitLab CI 集成

### 1\. 基本配置

#### 示例：GitLab CI 配置

    yaml


    # .gitlab-ci.yml

    stages:
      - review
      - test
      - deploy

    variables:
      ANTHROPIC_API_KEY: $ANTHROPIC_API_KEY

    code-review:
      stage: review
      image: node:18
      before_script:
        - npm install -g @anthropic-ai/claude-code
        - claude login --api-key $ANTHROPIC_API_KEY
      script:
        - claude -p "审查最近的代码变更" --output-format json > review.json
      artifacts:
        paths:
          - review.json
        expire_in: 1 week

    automated-testing:
      stage: test
      image: python:3.10
      before_script:
        - npm install -g @anthropic-ai/claude-code
        - claude login --api-key $ANTHROPIC_API_KEY
        - pip install pytest
      script:
        - claude -p "生成测试用例" --output-format json > tests.json
        - claude -p "运行测试" --input-format json < tests.json
      artifacts:
        paths:
          - tests.json
        expire_in: 1 week

    deploy:
      stage: deploy
      image: node:18
      before_script:
        - npm install -g @anthropic-ai/claude-code
        - claude login --api-key $ANTHROPIC_API_KEY
      script:
        - claude -p "部署应用到生产环境"
      only:
        - main

### 2\. 高级工作流

#### 示例：多阶段工作流

    yaml


    # .gitlab-ci.yml

    stages:
      - analyze
      - review
      - test
      - document
      - deploy

    variables:
      ANTHROPIC_API_KEY: $ANTHROPIC_API_KEY
      PROJECT_DIR: ./src

    code-analysis:
      stage: analyze
      image: node:18
      before_script:
        - npm install -g @anthropic-ai/claude-code
        - claude login --api-key $ANTHROPIC_API_KEY
      script:
        - claude --add-dir $PROJECT_DIR -p "分析代码质量" --output-format json > analysis.json
      artifacts:
        paths:
          - analysis.json
        expire_in: 1 week

    code-review:
      stage: review
      image: node:18
      dependencies:
        - code-analysis
      before_script:
        - npm install -g @anthropic-ai/claude-code
        - claude login --api-key $ANTHROPIC_API_KEY
      script:
        - claude -p "根据分析结果进行代码审查" --input-format json < analysis.json > review.json
      artifacts:
        paths:
          - review.json
        expire_in: 1 week

    automated-testing:
      stage: test
      image: python:3.10
      dependencies:
        - code-review
      before_script:
        - npm install -g @anthropic-ai/claude-code
        - claude login --api-key $ANTHROPIC_API_KEY
        - pip install pytest pytest-cov
      script:
        - claude -p "生成测试用例" --output-format json > tests.json
        - claude -p "运行测试" --input-format json < tests.json
        - claude -p "生成覆盖率报告" --output-format json > coverage.json
      artifacts:
        paths:
          - tests.json
          - coverage.json
        expire_in: 1 week

    documentation:
      stage: document
      image: node:18
      dependencies:
        - automated-testing
      before_script:
        - npm install -g @anthropic-ai/claude-code
        - claude login --api-key $ANTHROPIC_API_KEY
      script:
        - claude -p "生成项目文档" --output-format markdown > README.md
        - claude -p "生成 API 文档" --output-format html > API.html
      artifacts:
        paths:
          - README.md
          - API.html
        expire_in: 1 week

    deploy:
      stage: deploy
      image: node:18
      dependencies:
        - documentation
      before_script:
        - npm install -g @anthropic-ai/claude-code
        - claude login --api-key $ANTHROPIC_API_KEY
      script:
        - claude -p "部署应用到生产环境"
      only:
        - main

## Jenkins 集成

### 1\. 基本配置

#### 示例：Jenkins Pipeline

    groovy


    pipeline {
        agent any

        environment {
            ANTHROPIC_API_KEY = credentials('anthropic-api-key')
        }

        stages {
            stage('Checkout') {
                steps {
                    checkout scm
                }
            }

            stage('Install Claude Code') {
                steps {
                    sh 'npm install -g @anthropic-ai/claude-code'
                }
            }

            stage('Configure') {
                steps {
                    sh 'claude login --api-key $ANTHROPIC_API_KEY'
                }
            }

            stage('Code Review') {
                steps {
                    sh '''
                        claude -p "审查最近的代码变更" \
                            --output-format json \
                            > review.json
                    '''
                }
            }

            stage('Run Tests') {
                steps {
                    sh '''
                        claude -p "生成测试用例" \
                            --output-format json \
                            > tests.json

                        claude -p "运行测试" \
                            --input-format json \
                            < tests.json
                    '''
                }
            }

            stage('Generate Documentation') {
                steps {
                    sh '''
                        claude -p "生成项目文档" \
                            --output-format markdown \
                            > README.md
                    '''
                }
            }
        }

        post {
            always {
                archiveArtifacts artifacts: '*.json,*.md', fingerprint: true
            }
        }
    }

### 2\. 高级配置

#### 示例：多分支 Pipeline

    groovy


    pipeline {
        agent any

        environment {
            ANTHROPIC_API_KEY = credentials('anthropic-api-key')
        }

        stages {
            stage('Checkout') {
                steps {
                    checkout scm
                }
            }

            stage('Install Claude Code') {
                steps {
                    sh 'npm install -g @anthropic-ai/claude-code'
                }
            }

            stage('Configure') {
                steps {
                    sh 'claude login --api-key $ANTHROPIC_API_KEY'
                }
            }

            stage('Analyze') {
                steps {
                    sh '''
                        claude --add-dir ./src \
                            -p "分析代码质量" \
                            --output-format json \
                            > analysis.json
                    '''
                }
            }

            stage('Review') {
                when {
                    anyOf {
                        branch 'main'
                        branch 'develop'
                    }
                }
                steps {
                    sh '''
                        claude -p "进行代码审查" \
                            --input-format json \
                            < analysis.json \
                            > review.json
                    '''
                }
            }

            stage('Test') {
                steps {
                    sh '''
                        claude -p "生成并运行测试" \
                            --output-format json \
                            > test_results.json
                    '''
                }
            }

            stage('Document') {
                steps {
                    sh '''
                        claude -p "生成文档" \
                            --output-format markdown \
                            > docs.md
                    '''
                }
            }

            stage('Deploy') {
                when {
                    branch 'main'
                }
                steps {
                    sh 'claude -p "部署应用"'
                }
            }
        }

        post {
            always {
                archiveArtifacts artifacts: '*.json,*.md', fingerprint: true
            }
            success {
                echo 'Pipeline 执行成功'
            }
            failure {
                echo 'Pipeline 执行失败'
            }
        }
    }

## 最佳实践

### 1\. 安全性

```

  * **使用 Secrets** ：使用 CI/CD 平臺的 Secrets 功能儲存 API 金鑰
  * **環境變數** ：使用環境變數傳遞敏感資訊
  * **許可權控制** ：限制 Claude Code 的許可權範圍
  * **審計日誌** ：記錄所有 Claude Code 的呼叫

```yaml
#### 示例：安全配置

    yaml


    # GitHub Actions
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    # GitLab CI
    variables:
      ANTHROPIC_API_KEY: $ANTHROPIC_API_KEY

    # Jenkins
    environment {
        ANTHROPIC_API_KEY = credentials('anthropic-api-key')
    }

### 2\. 性能优化

```

  * **並行執行** ：並行執行獨立的任務
  * **快取依賴** ：快取依賴項以減少安裝時間
  * **增量處理** ：只處理變更的檔案
  * **結果快取** ：快取 Claude Code 的結果

```yaml
#### 示例：性能优化

    yaml


    # GitHub Actions - 并行执行
    jobs:
      review:
        runs-on: ubuntu-latest
        steps:
          - name: Code review
            run: claude -p "审查代码"

      test:
        runs-on: ubuntu-latest
        steps:
          - name: Run tests
            run: claude -p "运行测试"

### 3\. 错误处理

```

  * **失敗重試** ：配置失敗重試機制
  * **錯誤通知** ：配置錯誤通知
  * **回滾機制** ：配置回滾機制
  * **日誌記錄** ：記錄詳細的日誌

```yaml
#### 示例：错误处理

    yaml


    # GitHub Actions - 失败重试
    - name: Run Claude Code
      uses: nick-invision/retry@v2
      with:
        timeout_minutes: 10
        max_attempts: 3
        command: claude -p "执行任务"

### 4\. 成本控制

```

  * **限制呼叫次數** ：限制 Claude Code 的呼叫次數
  * **使用快取** ：使用快取減少重複呼叫
  * **最佳化提示** ：最佳化提示詞以減少 token 使用
  * **監控成本** ：監控 API 呼叫成本

```yaml
#### 示例：成本控制

    yaml


    # 使用缓存
    - name: Check cache
      id: cache
      uses: actions/cache@v3
      with:
        path: ~/.claude
        key: ${{ runner.os }}-claude-${{ hashFiles('**/package.json') }}

    - name: Run Claude Code
      if: steps.cache.outputs.cache-hit != 'true'
      run: claude -p "执行任务"

## 常见问题

### Q: 如何处理认证失败？

A: 检查 API 密钥是否正确配置，确保使用 CI/CD 平台的 Secrets 功能存储密钥。

### Q: 如何优化 CI/CD 流程的执行时间？

A: 使用并行执行、缓存依赖、增量处理等技术优化执行时间。

### Q: 如何处理 Claude Code 执行失败？

A: 配置失败重试机制、错误通知和回滚机制。

### Q: 如何控制 API 调用成本？

A: 限制调用次数、使用缓存、优化提示词、监控成本。

## 总结

```

將 Claude Code 整合到 CI/CD 流程中可以顯著提高開發效率和程式碼質量。透過掌握 GitHub Actions、GitLab CI 和 Jenkins 的整合方法，以及最佳實踐（安全性、效能最佳化、錯誤處理、成本控制），您可以構建強大、可靠的 CI/CD 流程。

記住以下要點：

  1. **從簡單開始** ：先實現基本的整合，逐步增加複雜性
  2. **注重安全** ：使用 Secrets 和環境變數保護敏感資訊
  3. **最佳化效能** ：使用並行執行和快取提高效率
  4. **控制成本** ：監控和控制 API 呼叫成本
  5. **持續改進** ：不斷最佳化和改進 CI/CD 流程

在接下來的章節中，我們將學習批處理操作和實際工作流示例。
